# Assignment report

## End to End Benchmarks (MBAir)
|    | device   |   batch_size | compile   | model   |   context_length |   fwd avg (sec) |   fwd std (sec) |   back avg (sec) |   back std (sec) |   fws & back avg (sec) |   fws & back std (sec) | status   |
|---:|:---------|-------------:|:----------|:--------|-----------------:|----------------:|----------------:|-----------------:|-----------------:|-----------------------:|-----------------------:|:---------|
|  0 | cpu      |            4 | False     | S       |              256 |        0.292967 |       0.0101263 |         0.690617 |        0.0515558 |               0.983585 |              0.0505515 | ok       |
|  1 | cpu      |            4 | False     | M       |              256 |        1.07968  |       0.0161518 |         2.07311  |        0.122161  |               3.15279  |              0.121089  | ok       |
|  2 | cpu      |            4 | False     | L       |              256 |        2.517    |       0.0938035 |         5.54676  |        0.212342  |               8.06376  |              0.1905    | ok       |
|  0 | cpu      |            4 | True      | S       |              256 |        0.295624 |      0.00836923 |         0.671863 |        0.0613006 |               0.967486 |              0.0607266 | ok       |
|  1 | cpu      |            4 | True      | M       |              256 |        1.06595  |      0.0177598  |         2.06168  |        0.0460032 |               3.12763  |              0.0424368 | ok       |
|  2 | cpu      |            4 | True      | L       |              256 |        2.46093  |      0.0541857  |         5.35662  |        0.159464  |               7.81755  |              0.149976  | ok       |
|  0 | mps      |            4 | False     | S       |              256 |        0.152136 |     0.000323014 |         0.350633 |       0.00910346 |               0.502768 |             0.00909772 | ok       |
|  1 | mps      |            4 | False     | M       |              256 |        0.497226 |     0.0113818   |         1.05638  |       0.0234968  |               1.55361  |             0.0205562  | ok       |
|  2 | mps      |            4 | False     | L       |              256 |        1.08069  |     0.0256076   |         2.58213  |       0.252054   |               3.66281  |             0.25075    | ok       |
|  0 | mps      |            4 | True      | S       |              256 |        0.154377 |      0.00253189 |         0.351856 |        0.0111889 |               0.506234 |              0.0108987 | ok       |
|  1 | mps      |            4 | True      | M       |              256 |        0.493877 |      0.00840203 |         1.05395  |        0.0220565 |               1.54783  |              0.0203935 | ok       |
|  2 | mps      |            4 | True      | L       |              256 |        1.09464  |      0.0196739  |         3.15047  |        0.487463  |               4.24511  |              0.487066  | ok       |

## End to End Benchmarks (RTX PRO 6000 WK)

|    | model   |   context_length |   fwd avg (sec) |   fwd std (sec) |   back avg (sec) |   back std (sec) |   fws & back avg (sec) |   fws & back std (sec) | status   | dtype   | device   |   batch_size | compile   | profile_memory   |
|---:|:--------|-----------------:|----------------:|----------------:|-----------------:|-----------------:|-----------------------:|-----------------------:|:---------|:--------|:---------|-------------:|:----------|:-----------------|
|  0 | S       |              256 |       0.0101203 |     4.39494e-05 |        0.0141196 |      0.000145315 |              0.0242399 |            0.000138509 | ok       | float32 | cuda     |            4 | False     | False            |
|  1 | M       |              256 |       0.0202569 |     9.18798e-05 |        0.0340681 |      0.00021485  |              0.0543251 |            0.000194213 | ok       | float32 | cuda     |            4 | False     | False            |
|  2 | L       |              256 |       0.0299634 |     6.69663e-05 |        0.0640944 |      0.000134777 |              0.0940578 |            0.000116963 | ok       | float32 | cuda     |            4 | False     | False            |
|  3 | XL      |              256 |       0.0497967 |     4.44305e-05 |        0.111272  |      7.55653e-05 |              0.161069  |            6.11232e-05 | ok       | float32 | cuda     |            4 | False     | False            |
|  4 | 2p7     |              256 |       0.0603869 |     0.000155709 |        0.160571  |      0.000173022 |              0.220958  |            7.54412e-05 | ok       | float32 | cuda     |            4 | False     | False            |

### No Warm-up

|    | model   |   context_length |   fwd avg (sec) |   fwd std (sec) |   back avg (sec) |   back std (sec) |   fws & back avg (sec) |   fws & back std (sec) | status   | dtype   | device   |   batch_size | compile   | profile_memory   |
|---:|:--------|-----------------:|----------------:|----------------:|-----------------:|-----------------:|-----------------------:|-----------------------:|:---------|:--------|:---------|-------------:|:----------|:-----------------|
|  0 | S       |              256 |       0.0353005 |      0.0790442  |      -0.00274821 |       0.0821705  |              0.0325523 |            0.0224501   | ok       | float32 | cuda     |            4 | False     | False            |
|  1 | M       |              256 |       0.034033  |      0.0423463  |       0.0219129  |       0.0424403  |              0.0559458 |            0.00282343  | ok       | float32 | cuda     |            4 | False     | False            |
|  2 | L       |              256 |       0.0352378 |      0.0151886  |       0.0588802  |       0.0151966  |              0.094118  |            0.000493203 | ok       | float32 | cuda     |            4 | False     | False            |
|  3 | XL      |              256 |       0.052992  |      0.00997852 |       0.110647   |       0.0100072  |              0.163639  |            0.000756646 | ok       | float32 | cuda     |            4 | False     | False            |
|  4 | 2p7     |              256 |       0.062647  |      0.00871239 |       0.158404   |       0.00873731 |              0.221051  |            0.000659412 | ok       | float32 | cuda     |            4 | False     | False            |

### 1 step warm up

|    | model   |   context_length |   fwd avg (sec) |   fwd std (sec) |   back avg (sec) |   back std (sec) |   fws & back avg (sec) |   fws & back std (sec) | status   | dtype   | device   |   batch_size | compile   | profile_memory   |
|---:|:--------|-----------------:|----------------:|----------------:|-----------------:|-----------------:|-----------------------:|-----------------------:|:---------|:--------|:---------|-------------:|:----------|:-----------------|
|  0 | S       |              256 |       0.0103984 |     0.000120235 |        0.0148159 |      0.00131654  |              0.0252143 |            0.00131104  | ok       | float32 | cuda     |            4 | False     | False            |
|  1 | M       |              256 |       0.0305459 |     0.0310978   |        0.0548498 |      0.0825875   |              0.0853957 |            0.0765089   | ok       | float32 | cuda     |            4 | False     | False            |
|  2 | L       |              256 |       0.0305613 |     0.000196254 |        0.0641871 |      0.000258344 |              0.0947484 |            0.000168006 | ok       | float32 | cuda     |            4 | False     | False            |
|  3 | XL      |              256 |       0.0499383 |     8.81006e-05 |        0.114248  |      0.000240845 |              0.164186  |            0.000224153 | ok       | float32 | cuda     |            4 | False     | False            |
|  4 | 2p7     |              256 |       0.0600362 |     0.00103386  |        0.161622  |      0.00105505  |              0.221659  |            0.000210359 | ok       | float32 | cuda     |            4 | False     | False            |

### Mixed Precision (bfloat16)

|    | model   |   context_length |   fwd avg (sec) |   fwd std (sec) |   back avg (sec) |   back std (sec) |   fws & back avg (sec) |   fws & back std (sec) | status   | dtype    | device   |   batch_size | compile   | profile_memory   |
|---:|:--------|-----------------:|----------------:|----------------:|-----------------:|-----------------:|-----------------------:|-----------------------:|:---------|:---------|:---------|-------------:|:----------|:-----------------|
|  0 | S       |              256 |       0.0115468 |     0.00025475  |        0.016251  |      0.00029472  |              0.0277978 |            0.000148198 | ok       | bfloat16 | cuda     |            4 | False     | False            |
|  1 | M       |              256 |       0.0242751 |     0.000599148 |        0.0316248 |      0.000637135 |              0.0558999 |            0.000216708 | ok       | bfloat16 | cuda     |            4 | False     | False            |
|  2 | L       |              256 |       0.0333411 |     6.47849e-05 |        0.0668117 |      9.27532e-05 |              0.100153  |            6.63783e-05 | ok       | bfloat16 | cuda     |            4 | False     | False            |
|  3 | XL      |              256 |       0.0547619 |     6.14746e-05 |        0.112735  |      0.000142991 |              0.167497  |            0.000129102 | ok       | bfloat16 | cuda     |            4 | False     | False            |
|  4 | 2p7     |              256 |       0.0485177 |     4.27052e-05 |        0.115897  |      7.1541e-05  |              0.164415  |            5.73967e-05 | ok       | bfloat16 | cuda     |            4 | False     | False            |

### Compiled

|    | model   |   context_length |   fwd avg (sec) |   fwd std (sec) |   back avg (sec) |   back std (sec) |   fws & back avg (sec) |   fws & back std (sec) | status   | dtype   | device   |   batch_size | compile   | profile_memory   |
|---:|:--------|-----------------:|----------------:|----------------:|-----------------:|-----------------:|-----------------------:|-----------------------:|:---------|:--------|:---------|-------------:|:----------|:-----------------|
|  0 | S       |              256 |      0.00508969 |     2.39174e-05 |       0.00899177 |      2.61624e-05 |              0.0140815 |            1.06034e-05 | ok       | float32 | cuda     |            4 | True      | False            |
|  1 | M       |              256 |      0.0356223  |     0.0792748   |       0.00021299 |      0.079275    |              0.0358352 |            0.00017528  | ok       | float32 | cuda     |            4 | True      | False            |
|  2 | L       |              256 |      0.0179603  |     0.000290359 |       0.0503096  |      0.000323146 |              0.0682699 |            0.000141828 | ok       | float32 | cuda     |            4 | True      | False            |
|  3 | XL      |              256 |      0.0385235  |     0.000203871 |       0.0943493  |      0.000235015 |              0.132873  |            0.000116913 | ok       | float32 | cuda     |            4 | True      | False            |
|  4 | 2p7     |              256 |      0.0516872  |     0.000636176 |       0.141835   |      0.000672963 |              0.193522  |            0.000219452 | ok       | float32 | cuda     |            4 | True      | False            |

### Mixed precision (bfloat16) & compiled

|    | model   |   context_length |   fwd avg (sec) |   fwd std (sec) |   back avg (sec) |   back std (sec) |   fws & back avg (sec) |   fws & back std (sec) | status   | dtype    | device   |   batch_size | compile   | profile_memory   |
|---:|:--------|-----------------:|----------------:|----------------:|-----------------:|-----------------:|-----------------------:|-----------------------:|:---------|:---------|:---------|-------------:|:----------|:-----------------|
|  0 | S       |              256 |      0.00615928 |     4.13104e-05 |       0.00826505 |      0.000401961 |              0.0144243 |            0.000399833 | ok       | bfloat16 | cuda     |            4 | True      | False            |
|  1 | M       |              256 |      0.0132246  |     2.07604e-05 |       0.019979   |      0.000427588 |              0.0332035 |            0.000427084 | ok       | bfloat16 | cuda     |            4 | True      | False            |
|  2 | L       |              256 |      0.0194133  |     7.00106e-05 |       0.0518976  |      0.00020119  |              0.0713109 |            0.000188615 | ok       | bfloat16 | cuda     |            4 | True      | False            |
|  3 | XL      |              256 |      0.0421143  |     7.45255e-05 |       0.0954155  |      0.000139824 |              0.13753   |            0.000118307 | ok       | bfloat16 | cuda     |            4 | True      | False            |
|  4 | 2p7     |              256 |      0.0370287  |     0.000182895 |       0.102367   |      0.000217848 |              0.139396  |            0.000118352 | ok       | bfloat16 | cuda     |            4 | True      | False            |

## Profiling (Lmabda.ai - GH200 (AMD+H100))

`uv run nsys profile -o data/result --trace=cuda,nvtx,osrt  python cs336_systems/run_benchmark.py --context_lengths 128 256 512 1024 && QdstrmImporter -i data/result.qdstrm -o data/result.nsys-rep`

|    | model   |   context_length |   fwd avg (sec) |   fwd std (sec) |   back avg (sec) |   back std (sec) |   fws & back avg (sec) |   fws & back std (sec) | status                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | dtype   | device   |   batch_size | compile   | profile_memory   |
|---:|:--------|-----------------:|----------------:|----------------:|-----------------:|-----------------:|-----------------------:|-----------------------:|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:--------|:---------|-------------:|:----------|:-----------------|
|  0 | S       |              128 |       0.0297276 |     6.43929e-05 |        0.032579  |      0.000191016 |              0.0623066 |            0.000179835 | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
|  1 | S       |              256 |       0.0374801 |     0.0227022   |        0.0275381 |      0.0227419   |              0.0650182 |            0.00134428  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
|  2 | S       |              512 |       0.0306882 |     0.000164014 |        0.0343828 |      0.000192501 |              0.065071  |            0.000100777 | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
|  3 | S       |             1024 |       0.0319392 |     0.00018844  |        0.0558522 |      0.00103676  |              0.0877913 |            0.00101949  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
|  4 | M       |              128 |       0.0603757 |     0.00028553  |        0.065929  |      0.00184746  |              0.126305  |            0.00182526  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
|  5 | M       |              256 |       0.0595388 |     7.94143e-05 |        0.065308  |      0.00189705  |              0.124847  |            0.00189539  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
|  6 | M       |              512 |       0.0610791 |     0.000194767 |        0.0710212 |      0.00140497  |              0.1321    |            0.0013914   | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
|  7 | M       |             1024 |       0.0785329 |     3.53969e-05 |        0.160135  |      8.69219e-05 |              0.238668  |            7.93881e-05 | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
|  8 | L       |              128 |       0.090567  |     0.000413846 |        0.0960406 |      0.00116146  |              0.186608  |            0.00108522  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
|  9 | L       |              256 |       0.0910289 |     0.00131902  |        0.0987937 |      0.00264861  |              0.189823  |            0.00229681  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
| 10 | L       |              512 |       0.0938744 |     0.00018908  |        0.120604  |      0.000438911 |              0.214478  |            0.000396096 | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
| 11 | L       |             1024 |       0.125786  |     0.000898871 |        0.277623  |      0.0011319   |              0.403409  |            0.000687915 | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
| 12 | XL      |              128 |       0.121276  |     0.00159752  |        0.131556  |      0.00375187  |              0.252833  |            0.00339477  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
| 13 | XL      |              256 |       0.123595  |     0.0028885   |        0.13211   |      0.00405528  |              0.255705  |            0.00284638  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
| 14 | XL      |              512 |       0.134069  |     0.0256316   |        0.197223  |      0.0256885   |              0.331292  |            0.00170799  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
| 15 | XL      |             1024 |     nan         |   nan           |      nan         |    nan           |            nan         |          nan           | OutOfMemoryError: CUDA out of memory. Tried to allocate 400.00 MiB. GPU 0 has a total capacity of 79.19 GiB of which 401.00 MiB is free. Including non-PyTorch memory, this process has 78.79 GiB memory in use. Of the allocated memory 75.93 GiB is allocated by PyTorch, and 2.10 GiB is reserved by PyTorch but unallocated. If reserved but unallocated memory is large try setting PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True to avoid fragmentation.  See documentation for Memory Management  (https://pytorch.org/docs/stable/notes/cuda.html#environment-variables) | float32 | cuda     |            4 | False     | False            |
| 16 | 2p7     |              128 |       0.0831729 |     0.00114024  |        0.0889287 |      0.00126134  |              0.172102  |            0.000539308 | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
| 17 | 2p7     |              256 |       0.0839792 |     0.00110514  |        0.135405  |      0.002208    |              0.219384  |            0.00191153  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
| 18 | 2p7     |              512 |       0.0955784 |     0.00016756  |        0.237332  |      0.000274998 |              0.332911  |            0.000218053 | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
| 19 | 2p7     |             1024 |     nan         |   nan           |      nan         |    nan           |            nan         |          nan           | OutOfMemoryError: CUDA out of memory. Tried to allocate 512.00 MiB. GPU 0 has a total capacity of 79.19 GiB of which 405.00 MiB is free. Including non-PyTorch memory, this process has 78.79 GiB memory in use. Of the allocated memory 74.39 GiB is allocated by PyTorch, and 3.64 GiB is reserved by PyTorch but unallocated. If reserved but unallocated memory is large try setting PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True to avoid fragmentation.  See documentation for Memory Management  (https://pytorch.org/docs/stable/notes/cuda.html#environment-variables) | float32 | cuda     |            4 | False     | False            |


### Optimizer Step

`uv run nsys profile -o data/result_step --trace=cuda,nvtx,osrt  python cs336_systems/run_benchmark.py --context_lengths 128 256 512 1024 --run_opt && QdstrmImporter -i data/result_step.qdstrm -o data/result_step.nsys-rep`

|    | model   |   context_length |   fwd avg (sec) |   fwd std (sec) |   back avg (sec) |   back std (sec) |   fws & back avg (sec) |   fws & back std (sec) | status                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | dtype   | device   |   batch_size | compile   | profile_memory   |
|---:|:--------|-----------------:|----------------:|----------------:|-----------------:|-----------------:|-----------------------:|-----------------------:|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:--------|:---------|-------------:|:----------|:-----------------|
|  0 | S       |              128 |       0.0301504 |     0.000138516 |        0.054716  |      0.00122889  |              0.0848664 |            0.00122105  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
|  1 | S       |              256 |       0.03073   |     9.26036e-05 |        0.0561756 |      0.00142863  |              0.0869056 |            0.00142562  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
|  2 | S       |              512 |       0.03152   |     0.000629465 |        0.0555279 |      0.00165431  |              0.0870479 |            0.00152987  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
|  3 | S       |             1024 |       0.031976  |     0.00016431  |        0.0645133 |      0.000520158 |              0.0964893 |            0.000493525 | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
|  4 | M       |              128 |       0.0606668 |     0.000428725 |        0.106332  |      0.00136565  |              0.166998  |            0.00129661  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
|  5 | M       |              256 |       0.0599021 |     0.000208261 |        0.106925  |      0.00197687  |              0.166827  |            0.00196587  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
|  6 | M       |              512 |       0.0611248 |     0.000129721 |        0.107151  |      0.00215284  |              0.168276  |            0.00214893  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
|  7 | M       |             1024 |       0.0785291 |     4.19551e-05 |        0.189133  |      0.000674746 |              0.267662  |            0.00067344  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
|  8 | L       |              128 |       0.0914524 |     0.0014232   |        0.16747   |      0.0251819   |              0.258923  |            0.0251417   | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
|  9 | L       |              256 |       0.0913105 |     0.000205014 |        0.163487  |      0.00423675  |              0.254797  |            0.00423179  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
| 10 | L       |              512 |       0.0947784 |     0.00150856  |        0.173058  |      0.00191511  |              0.267837  |            0.00117978  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
| 11 | L       |             1024 |       0.125498  |     3.96035e-05 |        0.330247  |      0.000745437 |              0.455745  |            0.000744384 | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
| 12 | XL      |              128 |       0.121935  |     0.0014169   |        0.243207  |      0.00469235  |              0.365142  |            0.00447332  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
| 13 | XL      |              256 |       0.124299  |     0.000883434 |        0.246131  |      0.00303759  |              0.370431  |            0.00290628  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
| 14 | XL      |              512 |       0.128691  |     0.00154212  |        0.313373  |      0.00262349  |              0.442063  |            0.0021224   | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
| 15 | XL      |             1024 |     nan         |   nan           |      nan         |    nan           |            nan         |          nan           | OutOfMemoryError: CUDA out of memory. Tried to allocate 400.00 MiB. GPU 0 has a total capacity of 79.19 GiB of which 289.00 MiB is free. Including non-PyTorch memory, this process has 78.90 GiB memory in use. Of the allocated memory 75.59 GiB is allocated by PyTorch, and 2.56 GiB is reserved by PyTorch but unallocated. If reserved but unallocated memory is large try setting PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True to avoid fragmentation.  See documentation for Memory Management  (https://pytorch.org/docs/stable/notes/cuda.html#environment-variables) | float32 | cuda     |            4 | False     | False            |
| 16 | 2p7     |              128 |       0.0839421 |     0.000162272 |        0.259595  |      0.00453592  |              0.343537  |            0.00453302  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
| 17 | 2p7     |              256 |       0.085397  |     0.000296621 |        0.302555  |      0.00145358  |              0.387952  |            0.001423    | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
| 18 | 2p7     |              512 |     nan         |   nan           |      nan         |    nan           |            nan         |          nan           | OutOfMemoryError: CUDA out of memory. Tried to allocate 128.00 MiB. GPU 0 has a total capacity of 79.19 GiB of which 41.00 MiB is free. Including non-PyTorch memory, this process has 79.14 GiB memory in use. Of the allocated memory 75.23 GiB is allocated by PyTorch, and 3.16 GiB is reserved by PyTorch but unallocated. If reserved but unallocated memory is large try setting PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True to avoid fragmentation.  See documentation for Memory Management  (https://pytorch.org/docs/stable/notes/cuda.html#environment-variables)  | float32 | cuda     |            4 | False     | False            |
| 19 | 2p7     |             1024 |     nan         |   nan           |      nan         |    nan           |            nan         |          nan           | OutOfMemoryError: CUDA out of memory. Tried to allocate 512.00 MiB. GPU 0 has a total capacity of 79.19 GiB of which 175.00 MiB is free. Including non-PyTorch memory, this process has 79.01 GiB memory in use. Of the allocated memory 74.39 GiB is allocated by PyTorch, and 3.87 GiB is reserved by PyTorch but unallocated. If reserved but unallocated memory is large try setting PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True to avoid fragmentation.  See documentation for Memory Management  (https://pytorch.org/docs/stable/notes/cuda.html#environment-variables) | float32 | cuda     |            4 | False     | False            |

### Mixed precision (bfloat16)

`uv run nsys profile -o data/result_bflt16 --trace=cuda,nvtx,osrt  python cs336_systems/run_benchmark.py --context_lengths 128 256 512 1024 --run_opt  --autocast_dtype bfloat16 && QdstrmImporter -i data/result_bflt16.qdstrm -o data/result_bflt16.nsys-rep`

|    | model   |   context_length |   fwd avg (sec) |   fwd std (sec) |   back avg (sec) |   back std (sec) |   fws & back avg (sec) |   fws & back std (sec) | status                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | dtype    | device   |   batch_size | compile   | profile_memory   |
|---:|:--------|-----------------:|----------------:|----------------:|-----------------:|-----------------:|-----------------------:|-----------------------:|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:---------|:---------|-------------:|:----------|:-----------------|
|  0 | S       |              128 |       0.0326434 |     0.000153215 |        0.0593078 |      0.000869408 |              0.0919512 |            0.000855801 | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | bfloat16 | cuda     |            4 | False     | False            |
|  1 | S       |              256 |       0.0332623 |     0.000144421 |        0.0599617 |      0.00229878  |              0.093224  |            0.00229423  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | bfloat16 | cuda     |            4 | False     | False            |
|  2 | S       |              512 |       0.0344536 |     0.00150396  |        0.0584221 |      0.00222479  |              0.0928757 |            0.00163945  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | bfloat16 | cuda     |            4 | False     | False            |
|  3 | S       |             1024 |       0.0345267 |     0.000179395 |        0.059232  |      0.00143955  |              0.0937588 |            0.00142833  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | bfloat16 | cuda     |            4 | False     | False            |
|  4 | M       |              128 |       0.0671699 |     0.00187746  |        0.117844  |      0.00323002  |              0.185014  |            0.00262834  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | bfloat16 | cuda     |            4 | False     | False            |
|  5 | M       |              256 |       0.0669179 |     0.000223849 |        0.116421  |      0.00115783  |              0.183339  |            0.00113599  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | bfloat16 | cuda     |            4 | False     | False            |
|  6 | M       |              512 |       0.0678029 |     0.000286275 |        0.117402  |      0.00254129  |              0.185204  |            0.00252511  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | bfloat16 | cuda     |            4 | False     | False            |
|  7 | M       |             1024 |       0.0701521 |     0.00169573  |        0.157     |      0.00224239  |              0.227152  |            0.00146724  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | bfloat16 | cuda     |            4 | False     | False            |
|  8 | L       |              128 |       0.105814  |     0.0247      |        0.165462  |      0.0249203   |              0.271276  |            0.0033065   | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | bfloat16 | cuda     |            4 | False     | False            |
|  9 | L       |              256 |       0.100424  |     0.00231872  |        0.173543  |      0.00363528  |              0.273967  |            0.00279978  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | bfloat16 | cuda     |            4 | False     | False            |
| 10 | L       |              512 |       0.101459  |     0.00286461  |        0.173771  |      0.00408291  |              0.27523   |            0.00290933  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | bfloat16 | cuda     |            4 | False     | False            |
| 11 | L       |             1024 |       0.117463  |     0.000292364 |        0.273441  |      0.00109661  |              0.390904  |            0.00105691  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | bfloat16 | cuda     |            4 | False     | False            |
| 12 | XL      |              128 |       0.133042  |     0.00307708  |        0.258863  |      0.00419742  |              0.391904  |            0.00285481  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | bfloat16 | cuda     |            4 | False     | False            |
| 13 | XL      |              256 |       0.13563   |     0.0024187   |        0.258417  |      0.00389688  |              0.394047  |            0.00305542  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | bfloat16 | cuda     |            4 | False     | False            |
| 14 | XL      |              512 |       0.136469  |     0.00349694  |        0.276991  |      0.0287823   |              0.413459  |            0.0285691   | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | bfloat16 | cuda     |            4 | False     | False            |
| 15 | XL      |             1024 |     nan         |   nan           |      nan         |    nan           |            nan         |          nan           | OutOfMemoryError: CUDA out of memory. Tried to allocate 400.00 MiB. GPU 0 has a total capacity of 79.19 GiB of which 391.00 MiB is free. Including non-PyTorch memory, this process has 78.80 GiB memory in use. Of the allocated memory 75.94 GiB is allocated by PyTorch, and 2.11 GiB is reserved by PyTorch but unallocated. If reserved but unallocated memory is large try setting PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True to avoid fragmentation.  See documentation for Memory Management  (https://pytorch.org/docs/stable/notes/cuda.html#environment-variables) | bfloat16 | cuda     |            4 | False     | False            |
| 16 | 2p7     |              128 |       0.0902957 |     0.00235761  |        0.26883   |      0.00352615  |              0.359125  |            0.0026221   | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | bfloat16 | cuda     |            4 | False     | False            |
| 17 | 2p7     |              256 |       0.0912091 |     0.00196039  |        0.273951  |      0.00275293  |              0.36516   |            0.00193274  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | bfloat16 | cuda     |            4 | False     | False            |
| 18 | 2p7     |              512 |       0.0921048 |     0.000395242 |        0.343209  |      0.00251577  |              0.435314  |            0.00248453  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | bfloat16 | cuda     |            4 | False     | False            |
| 19 | 2p7     |             1024 |     nan         |   nan           |      nan         |    nan           |            nan         |          nan           | OutOfMemoryError: CUDA out of memory. Tried to allocate 512.00 MiB. GPU 0 has a total capacity of 79.19 GiB of which 481.00 MiB is free. Including non-PyTorch memory, this process has 78.71 GiB memory in use. Of the allocated memory 74.39 GiB is allocated by PyTorch, and 3.57 GiB is reserved by PyTorch but unallocated. If reserved but unallocated memory is large try setting PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True to avoid fragmentation.  See documentation for Memory Management  (https://pytorch.org/docs/stable/notes/cuda.html#environment-variables) | bfloat16 | cuda     |            4 | False     | False            |

### Mixed precision (bfloat16) & compiled

`uv run nsys profile -o data/result_comp_bflt16 --trace=cuda,nvtx,osrt  python cs336_systems/run_benchmark.py --context_lengths 128 256 512 1024 --run_opt --compile --autocast_dtype bfloat16 && QdstrmImporter -i data/result_comp_bflt16.qdstrm -o data/result_comp_bflt16.nsys-rep`

|    | model   |   context_length |   fwd avg (sec) |   fwd std (sec) |   back avg (sec) |   back std (sec) |   fws & back avg (sec) |   fws & back std (sec) | status                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | dtype    | device   |   batch_size | compile   | profile_memory   |
|---:|:--------|-----------------:|----------------:|----------------:|-----------------:|-----------------:|-----------------------:|-----------------------:|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:---------|:---------|-------------:|:----------|:-----------------|
|  0 | S       |              128 |       0.0188101 |     0.000143837 |        0.0428073 |      0.000348849 |              0.0616175 |            0.000317816 | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | bfloat16 | cuda     |            4 | True      | False            |
|  1 | S       |              256 |       0.0213717 |     5.69412e-05 |        0.0438185 |      0.000333022 |              0.0651902 |            0.000328118 | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | bfloat16 | cuda     |            4 | True      | False            |
|  2 | S       |              512 |       0.0215122 |     0.000128771 |        0.0435473 |      0.000420401 |              0.0650595 |            0.000400194 | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | bfloat16 | cuda     |            4 | True      | False            |
|  3 | S       |             1024 |       0.0421541 |     0.000211002 |        0.0557475 |      0.000795543 |              0.0979016 |            0.000767051 | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | bfloat16 | cuda     |            4 | True      | False            |
|  4 | M       |              128 |       0.0772373 |     0.000214572 |        0.109693  |      0.00229314  |              0.186931  |            0.00228308  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | bfloat16 | cuda     |            4 | True      | False            |
|  5 | M       |              256 |       0.077675  |     0.00163737  |        0.108917  |      0.00199007  |              0.186592  |            0.00113111  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | bfloat16 | cuda     |            4 | True      | False            |
|  6 | M       |              512 |       0.0778343 |     0.000243294 |        0.109438  |      0.00229513  |              0.187272  |            0.0022822   | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | bfloat16 | cuda     |            4 | True      | False            |
|  7 | M       |             1024 |       0.078765  |     0.00155529  |        0.148765  |      0.00209977  |              0.22753   |            0.0014107   | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | bfloat16 | cuda     |            4 | True      | False            |
|  8 | L       |              128 |       0.114053  |     0.000272733 |        0.161513  |      0.00212904  |              0.275565  |            0.0021115   | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | bfloat16 | cuda     |            4 | True      | False            |
|  9 | L       |              256 |       0.126551  |     0.0020609   |        0.182663  |      0.00544188  |              0.309215  |            0.00503654  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | bfloat16 | cuda     |            4 | True      | False            |
| 10 | L       |              512 |       0.1276    |     0.00320123  |        0.177261  |      0.00467972  |              0.304861  |            0.00341348  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | bfloat16 | cuda     |            4 | True      | False            |
| 11 | L       |             1024 |       0.129307  |     0.000280664 |        0.272123  |      0.00247879  |              0.40143   |            0.00246285  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | bfloat16 | cuda     |            4 | True      | False            |
| 12 | XL      |              128 |       0.158075  |     0.00458744  |        0.257302  |      0.0058068   |              0.415377  |            0.00356011  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | bfloat16 | cuda     |            4 | True      | False            |
| 13 | XL      |              256 |       0.158984  |     0.00327682  |        0.26021   |      0.00547512  |              0.419194  |            0.00438627  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | bfloat16 | cuda     |            4 | True      | False            |
| 14 | XL      |              512 |       0.159908  |     0.00255282  |        0.266786  |      0.00336527  |              0.426694  |            0.00219275  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | bfloat16 | cuda     |            4 | True      | False            |
| 15 | XL      |             1024 |     nan         |   nan           |      nan         |    nan           |            nan         |          nan           | OutOfMemoryError: CUDA out of memory. Tried to allocate 400.00 MiB. GPU 0 has a total capacity of 79.19 GiB of which 75.00 MiB is free. Including non-PyTorch memory, this process has 79.11 GiB memory in use. Of the allocated memory 75.95 GiB is allocated by PyTorch, and 2.40 GiB is reserved by PyTorch but unallocated. If reserved but unallocated memory is large try setting PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True to avoid fragmentation.  See documentation for Memory Management  (https://pytorch.org/docs/stable/notes/cuda.html#environment-variables)  | bfloat16 | cuda     |            4 | True      | False            |
| 16 | 2p7     |              128 |       0.106174  |     0.00180811  |        0.270186  |      0.0038956   |              0.376359  |            0.00345057  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | bfloat16 | cuda     |            4 | True      | False            |
| 17 | 2p7     |              256 |       0.10651   |     0.000318099 |        0.271752  |      0.00329783  |              0.378262  |            0.00328245  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | bfloat16 | cuda     |            4 | True      | False            |
| 18 | 2p7     |              512 |       0.108879  |     0.002216    |        0.342352  |      0.00335018  |              0.451232  |            0.00251257  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | bfloat16 | cuda     |            4 | True      | False            |
| 19 | 2p7     |             1024 |     nan         |   nan           |      nan         |    nan           |            nan         |          nan           | OutOfMemoryError: CUDA out of memory. Tried to allocate 512.00 MiB. GPU 0 has a total capacity of 79.19 GiB of which 421.00 MiB is free. Including non-PyTorch memory, this process has 78.77 GiB memory in use. Of the allocated memory 74.40 GiB is allocated by PyTorch, and 3.62 GiB is reserved by PyTorch but unallocated. If reserved but unallocated memory is large try setting PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True to avoid fragmentation.  See documentation for Memory Management  (https://pytorch.org/docs/stable/notes/cuda.html#environment-variables) | bfloat16 | cuda     |            4 | True      | False            |

### Memory (without AdamW)

`uv run nsys profile -o data/result_mem --trace=cuda,nvtx,osrt  python cs336_systems/run_benchmark.py --context_lengths 128 256 512 --models 2p7 --profile_memory --profile_memory_path data/result_mem_snapshot.pickle && QdstrmImporter -i data/result_mem.qdstrm -o data/result_mem.nsys-rep`


### Memory

`uv run nsys profile -o data/result_mem_step --trace=cuda,nvtx,osrt  python cs336_systems/run_benchmark.py --context_lengths 128 256 512 --run_opt --models 2p7 --profile_memory --profile_memory_path data/result_mem_step_snapshot.pickle && QdstrmImporter -i data/result_mem_step.qdstrm -o data/result_mem_step.nsys-rep`


### Memory with Mixed precision (bfloat16)

`uv run nsys profile -o data/result_mem_mixed_step --trace=cuda,nvtx,osrt  python cs336_systems/run_benchmark.py --context_lengths 128 256 512 --run_opt --autocast_dtype bfloat16 --models 2p7 --profile_memory --profile_memory_path data/result_mem_mixed_step_snapshot.pickle && QdstrmImporter -i data/result_mem_mixed_step.qdstrm -o data/result_mem_mixed_step.nsys-rep`


## Mixed precision

### mixed_precision_accumulation

float32: tensor(10.0001)

float16: tensor(9.9531, dtype=torch.float16)

float32 adding float16: tensor(10.0021)

float32 adding float16 manually upcast: tensor(10.0021)


This is due to the precision of float16 that cannot represent 0.01 correctly, even when upcast before addition.

## Self Attention (Apple M4)

### Benchmark

`uv run cs336_systems/run_attn_benchmark.py  --device=mps --context_lengths 16 32 --d_model 256 1024`

|    |   context_length |   d_model |   fwd avg (sec) |   fwd std (sec) |   back avg (sec) |   back std (sec) |   fws & back avg (sec) |   fws & back std (sec) |   model mem |   model+fwd mem |   model+fwd+back mem |   fwd mem |   back mem | status   | dtype   | device   |   batch_size | compile   | profile_memory   |
|---:|-----------------:|----------:|----------------:|----------------:|-----------------:|-----------------:|-----------------------:|-----------------------:|------------:|----------------:|---------------------:|----------:|-----------:|:---------|:--------|:---------|-------------:|:----------|:-----------------|
|  0 |               16 |       256 |     0.000964747 |     0.000140073 |      0.000628642 |      0.000244892 |             0.00159339 |            0.000200877 |           0 |               0 |                    0 |         0 |          0 | ok       | float32 | mps      |            8 | False     | False            |
|  1 |               32 |       256 |     0.000999366 |     0.000207542 |      0.00126654  |      0.000234368 |             0.00226591 |            0.00010888  |           0 |               0 |                    0 |         0 |          0 | ok       | float32 | mps      |            8 | False     | False            |
|  2 |               16 |      1024 |     0.00278449  |     0.000719188 |      0.00711855  |      0.000768673 |             0.00990304 |            0.000271344 |           0 |               0 |                    0 |         0 |          0 | ok       | float32 | mps      |            8 | False     | False            |
|  3 |               32 |      1024 |     0.00197874  |     0.00104569  |      0.00137835  |      0.00104589  |             0.00335709 |            1.9964e-05  |           0 |               0 |                    0 |         0 |          0 | ok       | float32 | mps      |            8 | False     | False            |

### Compiled Benchmark

`uv run cs336_systems/run_attn_benchmark.py  --device=mps --context_lengths 16 32 --d_model 256 1024 --compile`

|    |   context_length |   d_model |   fwd avg (sec) |   fwd std (sec) |   back avg (sec) |   back std (sec) |   fws & back avg (sec) |   fws & back std (sec) |   model mem |   model+fwd mem |   model+fwd+back mem |   fwd mem |   back mem | status   | dtype   | device   |   batch_size | compile   | profile_memory   |
|---:|-----------------:|----------:|----------------:|----------------:|-----------------:|-----------------:|-----------------------:|-----------------------:|------------:|----------------:|---------------------:|----------:|-----------:|:---------|:--------|:---------|-------------:|:----------|:-----------------|
|  0 |               16 |       256 |     0.000878016 |     0.000211566 |       0.00113324 |      0.000303261 |             0.00201126 |            0.000217272 |           0 |               0 |                    0 |         0 |          0 | ok       | float32 | mps      |            8 | True      | False            |
|  1 |               32 |       256 |     0.000910615 |     0.000155417 |       0.00137933 |      0.000228465 |             0.00228994 |            0.000167456 |           0 |               0 |                    0 |         0 |          0 | ok       | float32 | mps      |            8 | True      | False            |
|  2 |               16 |      1024 |     0.00134004  |     0.000286955 |       0.00747273 |      0.000728483 |             0.00881277 |            0.000669585 |           0 |               0 |                    0 |         0 |          0 | ok       | float32 | mps      |            8 | True      | False            |
|  3 |               32 |      1024 |     0.00255449  |     0.00138711  |       0.0110278  |      0.00154581  |             0.0135822  |            0.000682247 |           0 |               0 |                    0 |         0 |          0 | ok       | float32 | mps      |            8 | True      | False            |

## Self Attention (RTX PRO 6000 WK)

### Benchmark

`uv run cs336_systems/run_attn_benchmark.py --context_lengths 16 32 64 128 --d_model 256 1024 4096 8192 16384`

|    |   context_length |   d_model |   fwd avg (sec) |   fwd std (sec) |   back avg (sec) |   back std (sec) |   fws & back avg (sec) |   fws & back std (sec) |   model mem |   model+fwd mem |   model+fwd+back mem |   fwd mem |     back mem | status   | dtype   | device   |   batch_size | compile   | profile_memory   |
|---:|-----------------:|----------:|----------------:|----------------:|-----------------:|-----------------:|-----------------------:|-----------------------:|------------:|----------------:|---------------------:|----------:|-------------:|:---------|:--------|:---------|-------------:|:----------|:-----------------|
|  0 |               16 |       256 |     0.000271286 |     1.08077e-05 |      0.000786569 |      1.73418e-05 |             0.00105786 |            1.35621e-05 |       1.125 |         9.76807 |              18.3755 |   8.64307 |    8.60742   | ok       | float32 | cuda     |            8 | False     | False            |
|  1 |               32 |       256 |     0.000265495 |     1.55203e-05 |      0.00124403  |      0.000134814 |             0.00150953 |            0.000133918 |      17.5   |        18.5669  |              18.5005 |   1.06689 |   -0.0664062 | ok       | float32 | cuda     |            8 | False     | False            |
|  2 |               64 |       256 |     0.000262641 |     1.36041e-05 |      0.0013428   |      0.000117789 |             0.00160544 |            0.000117001 |      17.75  |        20.0103  |              18.7505 |   2.26025 |   -1.25977   | ok       | float32 | cuda     |            8 | False     | False            |
|  3 |              128 |       256 |     0.000266667 |     1.5486e-05  |      0.00132317  |      0.000118794 |             0.00158984 |            0.00011778  |      18.25  |        23.2778  |              19.2505 |   5.02783 |   -4.02734   | ok       | float32 | cuda     |            8 | False     | False            |
|  4 |               16 |      1024 |     0.000266494 |     1.44998e-05 |      0.00129249  |      0.000124481 |             0.00155899 |            0.000123633 |      32.75  |        34.7681  |              48.7505 |   2.01807 |   13.9824    | ok       | float32 | cuda     |            8 | False     | False            |
|  5 |               32 |      1024 |     0.000271278 |     2.53914e-05 |      0.00130747  |      0.000121699 |             0.00157874 |            0.00011902  |      33.25  |        37.3169  |              49.2505 |   4.06689 |   11.9336    | ok       | float32 | cuda     |            8 | False     | False            |
|  6 |               64 |      1024 |     0.000265415 |     6.65602e-06 |      0.00132602  |      0.000120484 |             0.00159143 |            0.0001203   |      34.25  |        42.5103  |              50.2505 |   8.26025 |    7.74023   | ok       | float32 | cuda     |            8 | False     | False            |
|  7 |              128 |      1024 |     0.000275188 |     1.99856e-05 |      0.00131234  |      0.000120253 |             0.00158753 |            0.00011858  |      36.25  |        53.2778  |              52.2505 |  17.0278  |   -1.02734   | ok       | float32 | cuda     |            8 | False     | False            |
|  8 |               16 |      4096 |     0.000309321 |     2.75456e-05 |      0.00136213  |      8.95057e-05 |             0.00167145 |            8.51617e-05 |     274.25  |       282.268   |             530.25   |   8.01807 |  247.982     | ok       | float32 | cuda     |            8 | False     | False            |
|  9 |               32 |      4096 |     0.000391526 |     1.60764e-05 |      0.00132274  |      2.14902e-05 |             0.00171427 |            1.4261e-05  |     276.25  |       292.317   |             532.25   |  16.0669  |  239.934     | ok       | float32 | cuda     |            8 | False     | False            |
| 10 |               64 |      4096 |     0.000565384 |     1.57666e-05 |      0.00125486  |      3.70508e-05 |             0.00182024 |            3.35287e-05 |     280.25  |       312.51    |             536.25   |  32.2603  |  223.74      | ok       | float32 | cuda     |            8 | False     | False            |
| 11 |              128 |      4096 |     0.00101811  |     9.20049e-06 |      0.00171886  |      2.63649e-05 |             0.00273697 |            2.47075e-05 |     288.25  |       353.278   |             544.25   |  65.0278  |  190.973     | ok       | float32 | cuda     |            8 | False     | False            |
| 12 |               16 |      8192 |     0.000907808 |     2.0173e-05  |      0.00388404  |      4.20323e-05 |             0.00479185 |            3.6875e-05  |    1044.25  |      1060.27    |            2068.25   |  16.0181  | 1007.98      | ok       | float32 | cuda     |            8 | False     | False            |
| 13 |               32 |      8192 |     0.00106873  |     1.72143e-05 |      0.00419683  |      4.44548e-05 |             0.00526555 |            4.09866e-05 |    1048.25  |      1080.32    |            2072.25   |  32.0669  |  991.934     | ok       | float32 | cuda     |            8 | False     | False            |
| 14 |               64 |      8192 |     0.00194413  |     2.04517e-05 |      0.00498954  |      4.04237e-05 |             0.00693367 |            3.48684e-05 |    1056.25  |      1120.51    |            2080.25   |  64.2603  |  959.74      | ok       | float32 | cuda     |            8 | False     | False            |
| 15 |              128 |      8192 |     0.00317446  |     0.000103875 |      0.00666155  |      0.000109163 |             0.00983601 |            3.35638e-05 |    1072.25  |      1201.28    |            2096.25   | 129.028   |  894.973     | ok       | float32 | cuda     |            8 | False     | False            |
| 16 |               16 |     16384 |     0.0029739   |     1.56024e-05 |      0.0160405   |      4.84658e-05 |             0.0190144  |            4.58857e-05 |    4120.25  |      4152.27    |            8216.25   |  32.0181  | 4063.98      | ok       | float32 | cuda     |            8 | False     | False            |
| 17 |               32 |     16384 |     0.00356875  |     7.53388e-05 |      0.0172272   |      8.3371e-05  |             0.0207959  |            3.57042e-05 |    4128.25  |      4192.32    |            8224.25   |  64.0669  | 4031.93      | ok       | float32 | cuda     |            8 | False     | False            |
| 18 |               64 |     16384 |     0.00652507  |     0.000136554 |      0.0202442   |      0.000143528 |             0.0267693  |            4.41946e-05 |    4144.25  |      4272.51    |            8240.25   | 128.26    | 3967.74      | ok       | float32 | cuda     |            8 | False     | False            |
| 19 |              128 |     16384 |     0.0129078   |     7.78602e-05 |      0.0273836   |      0.000106269 |             0.0402914  |            7.23256e-05 |    4176.25  |      4433.28    |            8272.25   | 257.028   | 3838.97      | ok       | float32 | cuda     |            8 | False     | False            |


### Compiled Benchmark

`uv run cs336_systems/run_attn_benchmark.py --context_lengths 16 32 64 128 --d_model 256 1024 4096 8192 16384 --compile`

|    |   context_length |   d_model |   fwd avg (sec) |   fwd std (sec) |   back avg (sec) |   back std (sec) |   fws & back avg (sec) |   fws & back std (sec) |   model mem |   model+fwd mem |   model+fwd+back mem |   fwd mem |     back mem | status   | dtype   | device   |   batch_size | compile   | profile_memory   |
|---:|-----------------:|----------:|----------------:|----------------:|-----------------:|-----------------:|-----------------------:|-----------------------:|------------:|----------------:|---------------------:|----------:|-------------:|:---------|:--------|:---------|-------------:|:----------|:-----------------|
|  0 |               16 |       256 |     0.000267303 |     8.55757e-06 |      0.000594411 |      2.65631e-05 |            0.000861714 |            2.51469e-05 |       1.125 |         9.76855 |              18.3755 |   8.64355 |    8.60693   | ok       | float32 | cuda     |            8 | True      | False            |
|  1 |               32 |       256 |     0.000296327 |     2.20317e-05 |      0.000609919 |      3.39948e-05 |            0.000906247 |            2.58891e-05 |      17.5   |        18.5679  |              18.5005 |   1.06787 |   -0.0673828 | ok       | float32 | cuda     |            8 | True      | False            |
|  2 |               64 |       256 |     0.000299617 |     1.06866e-05 |      0.00103669  |      0.000140244 |            0.00133631  |            0.000139836 |      17.75  |        20.0122  |              18.7505 |   2.26221 |   -1.26172   | ok       | float32 | cuda     |            8 | True      | False            |
|  3 |              128 |       256 |     0.000298187 |     1.44706e-05 |      0.00105322  |      0.000142114 |            0.00135141  |            0.000141375 |      18.25  |        23.2817  |              19.2505 |   5.03174 |   -4.03125   | ok       | float32 | cuda     |            8 | True      | False            |
|  4 |               16 |      1024 |     0.000297882 |     1.89604e-05 |      0.000997923 |      0.000136452 |            0.0012958   |            0.000135128 |      32.75  |        34.7686  |              48.7505 |   2.01855 |   13.9819    | ok       | float32 | cuda     |            8 | True      | False            |
|  5 |               32 |      1024 |     0.000300891 |     2.16117e-05 |      0.000968183 |      0.00013285  |            0.00126907  |            0.000131081 |      33.25  |        37.3179  |              49.2505 |   4.06787 |   11.9326    | ok       | float32 | cuda     |            8 | True      | False            |
|  6 |               64 |      1024 |     0.00029774  |     5.12982e-06 |      0.00101247  |      0.000141299 |            0.00131021  |            0.000141206 |      34.25  |        42.5122  |              50.2505 |   8.26221 |    7.73828   | ok       | float32 | cuda     |            8 | True      | False            |
|  7 |              128 |      1024 |     0.000391751 |     1.22404e-05 |      0.00137599  |      0.000187135 |            0.00176774  |            0.000186735 |      36.25  |        53.2817  |              52.2505 |  17.0317  |   -1.03125   | ok       | float32 | cuda     |            8 | True      | False            |
|  8 |               16 |      4096 |     0.000419893 |     8.26409e-06 |      0.00139276  |      2.06137e-05 |            0.00181265  |            1.88846e-05 |     274.25  |       282.269   |             530.25   |   8.01855 |  247.982     | ok       | float32 | cuda     |            8 | True      | False            |
|  9 |               32 |      4096 |     0.000442426 |     2.30392e-05 |      0.00145156  |      4.64621e-05 |            0.00189399  |            4.03475e-05 |     276.25  |       292.318   |             532.25   |  16.0679  |  239.933     | ok       | float32 | cuda     |            8 | True      | False            |
| 10 |               64 |      4096 |     0.000577996 |     1.73812e-05 |      0.00144546  |      0.000106687 |            0.00202346  |            0.000105262 |     280.25  |       312.512   |             536.25   |  32.2622  |  223.738     | ok       | float32 | cuda     |            8 | True      | False            |
| 11 |              128 |      4096 |     0.00104211  |     1.4977e-05  |      0.0016854   |      3.42011e-05 |            0.0027275   |            3.07474e-05 |     288.25  |       353.282   |             544.25   |  65.0317  |  190.969     | ok       | float32 | cuda     |            8 | True      | False            |
| 12 |               16 |      8192 |     0.000920803 |     1.29426e-05 |      0.0038514   |      1.83925e-05 |            0.0047722   |            1.3068e-05  |    1044.25  |      1060.27    |            2068.25   |  16.0186  | 1007.98      | ok       | float32 | cuda     |            8 | True      | False            |
| 13 |               32 |      8192 |     0.00108586  |     6.56704e-06 |      0.00419452  |      3.6297e-05  |            0.00528037  |            3.5698e-05  |    1048.25  |      1080.32    |            2072.25   |  32.0679  |  991.933     | ok       | float32 | cuda     |            8 | True      | False            |
| 14 |               64 |      8192 |     0.00196428  |     2.39286e-05 |      0.00497837  |      3.23258e-05 |            0.00694265  |            2.17342e-05 |    1056.25  |      1120.51    |            2080.25   |  64.2622  |  959.738     | ok       | float32 | cuda     |            8 | True      | False            |
| 15 |              128 |      8192 |     0.00320771  |     0.000101284 |      0.00667311  |      0.000104958 |            0.00988082  |            2.75295e-05 |    1072.25  |      1201.28    |            2096.25   | 129.032   |  894.969     | ok       | float32 | cuda     |            8 | True      | False            |
| 16 |               16 |     16384 |     0.00298836  |     3.20741e-05 |      0.0160167   |      5.90806e-05 |            0.0190051   |            4.96162e-05 |    4120.25  |      4152.27    |            8216.25   |  32.0186  | 4063.98      | ok       | float32 | cuda     |            8 | True      | False            |
| 17 |               32 |     16384 |     0.00360711  |     8.00947e-05 |      0.0173117   |      8.9043e-05  |            0.0209188   |            3.89035e-05 |    4128.25  |      4192.32    |            8224.25   |  64.0679  | 4031.93      | ok       | float32 | cuda     |            8 | True      | False            |
| 18 |               64 |     16384 |     0.00657813  |     0.000138736 |      0.0203767   |      0.000143095 |            0.0269549   |            3.50509e-05 |    4144.25  |      4272.51    |            8240.25   | 128.262   | 3967.74      | ok       | float32 | cuda     |            8 | True      | False            |
| 19 |              128 |     16384 |     0.0130529   |     9.64343e-05 |      0.0275808   |      0.000116273 |            0.0406336   |            6.49606e-05 |    4176.25  |      4433.28    |            8272.25   | 257.032   | 3838.97      | ok       | float32 | cuda     |            8 | True      | False            |

### Compiled & mixed precision benchmark

`uv run cs336_systems/run_attn_benchmark.py --context_lengths 16 32 64 128 --d_model 256 1024 4096 8192 16384 --compile --autocast_dtype bfloat16`

|    |   context_length |   d_model |   fwd avg (sec) |   fwd std (sec) |   back avg (sec) |   back std (sec) |   fws & back avg (sec) |   fws & back std (sec) |   model mem |   model+fwd mem |   model+fwd+back mem |   fwd mem |     back mem | status   | dtype    | device   |   batch_size | compile   | profile_memory   |
|---:|-----------------:|----------:|----------------:|----------------:|-----------------:|-----------------:|-----------------------:|-----------------------:|------------:|----------------:|---------------------:|----------:|-------------:|:---------|:---------|:---------|-------------:|:----------|:-----------------|
|  0 |               16 |       256 |     0.0003134   |     1.5832e-05  |      0.00169997  |      0.000144139 |             0.00201337 |            0.000143267 |       1.125 |         9.76855 |              18.3755 |   8.64355 |    8.60693   | ok       | bfloat16 | cuda     |            8 | True      | False            |
|  1 |               32 |       256 |     0.000366167 |     6.56843e-06 |      0.0016194   |      0.000219651 |             0.00198557 |            0.000219553 |      17.5   |        18.5679  |              18.5005 |   1.06787 |   -0.0673828 | ok       | bfloat16 | cuda     |            8 | True      | False            |
|  2 |               64 |       256 |     0.000452106 |     0.000166295 |      0.000994977 |      0.000224035 |             0.00144708 |            0.000150126 |      17.75  |        20.0122  |              18.7505 |   2.26221 |   -1.26172   | ok       | bfloat16 | cuda     |            8 | True      | False            |
|  3 |              128 |       256 |     0.000367245 |     5.61294e-06 |      0.000945897 |      0.000204387 |             0.00131314 |            0.00020431  |      18.25  |        23.2817  |              19.2505 |   5.03174 |   -4.03125   | ok       | bfloat16 | cuda     |            8 | True      | False            |
|  4 |               16 |      1024 |     0.000449759 |     3.95968e-05 |      0.00123576  |      0.000327825 |             0.00168552 |            0.000325425 |      32.75  |        34.7686  |              48.7505 |   2.01855 |   13.9819    | ok       | bfloat16 | cuda     |            8 | True      | False            |
|  5 |               32 |      1024 |     0.000440675 |     2.32512e-05 |      0.000718769 |      3.58027e-05 |             0.00115944 |            2.72252e-05 |      33.25  |        37.3179  |              49.2505 |   4.06787 |   11.9326    | ok       | bfloat16 | cuda     |            8 | True      | False            |
|  6 |               64 |      1024 |     0.000436621 |     7.74531e-06 |      0.00110746  |      0.000331627 |             0.00154408 |            0.000331536 |      34.25  |        42.5122  |              50.2505 |   8.26221 |    7.73828   | ok       | bfloat16 | cuda     |            8 | True      | False            |
|  7 |              128 |      1024 |     0.000448461 |     1.5668e-05  |      0.00137835  |      0.000217146 |             0.00182681 |            0.00021658  |      36.25  |        53.2817  |              52.2505 |  17.0317  |   -1.03125   | ok       | bfloat16 | cuda     |            8 | True      | False            |
|  8 |               16 |      4096 |     0.000503716 |     4.25288e-05 |      0.00133227  |      5.83995e-05 |             0.00183599 |            4.00225e-05 |     274.25  |       282.269   |             530.25   |   8.01855 |  247.982     | ok       | bfloat16 | cuda     |            8 | True      | False            |
|  9 |               32 |      4096 |     0.000508479 |     2.48039e-05 |      0.00120844  |      0.000198546 |             0.00171692 |            0.000196991 |     276.25  |       292.318   |             532.25   |  16.0679  |  239.933     | ok       | bfloat16 | cuda     |            8 | True      | False            |
| 10 |               64 |      4096 |     0.000564682 |     2.00019e-05 |      0.0012953   |      2.95064e-05 |             0.00185998 |            2.16922e-05 |     280.25  |       312.512   |             536.25   |  32.2622  |  223.738     | ok       | bfloat16 | cuda     |            8 | True      | False            |
| 11 |              128 |      4096 |     0.00083678  |     2.13139e-05 |      0.00123814  |      2.88769e-05 |             0.00207492 |            1.94832e-05 |     288.25  |       353.282   |             544.25   |  65.0317  |  190.969     | ok       | bfloat16 | cuda     |            8 | True      | False            |
| 12 |               16 |      8192 |     0.00142029  |     1.85187e-05 |      0.00449039  |      5.2422e-05  |             0.00591068 |            4.90421e-05 |    1044.25  |      1060.27    |            2068.25   |  16.0186  | 1007.98      | ok       | bfloat16 | cuda     |            8 | True      | False            |
| 13 |               32 |      8192 |     0.00158149  |     3.53316e-05 |      0.00469638  |      4.99561e-05 |             0.00627787 |            3.5317e-05  |    1048.25  |      1080.32    |            2072.25   |  32.0679  |  991.933     | ok       | bfloat16 | cuda     |            8 | True      | False            |
| 14 |               64 |      8192 |     0.00196204  |     1.65004e-05 |      0.00492166  |      3.86075e-05 |             0.00688371 |            3.49038e-05 |    1056.25  |      1120.51    |            2080.25   |  64.2622  |  959.738     | ok       | bfloat16 | cuda     |            8 | True      | False            |
| 15 |              128 |      8192 |     0.00283035  |     1.71987e-05 |      0.00569053  |      2.75805e-05 |             0.00852088 |            2.15613e-05 |    1072.25  |      1201.28    |            2096.25   | 129.032   |  894.969     | ok       | bfloat16 | cuda     |            8 | True      | False            |
| 16 |               16 |     16384 |     0.00596216  |     1.81466e-05 |      0.0189543   |      3.61582e-05 |             0.0249164  |            3.12748e-05 |    4120.25  |      4152.27    |            8216.25   |  32.0186  | 4063.98      | ok       | bfloat16 | cuda     |            8 | True      | False            |
| 17 |               32 |     16384 |     0.00605231  |     2.99457e-05 |      0.0200749   |      4.20042e-05 |             0.0261272  |            2.94552e-05 |    4128.25  |      4192.32    |            8224.25   |  64.0679  | 4031.93      | ok       | bfloat16 | cuda     |            8 | True      | False            |
| 18 |               64 |     16384 |     0.00770682  |     2.23741e-05 |      0.0207015   |      2.9735e-05  |             0.0284083  |            1.95849e-05 |    4144.25  |      4272.51    |            8240.25   | 128.262   | 3967.74      | ok       | bfloat16 | cuda     |            8 | True      | False            |
| 19 |              128 |     16384 |     0.00985856  |     1.04729e-05 |      0.0238756   |      2.63087e-05 |             0.0337342  |            2.41344e-05 |    4176.25  |      4433.28    |            8272.25   | 257.032   | 3838.97      | ok       | bfloat16 | cuda     |            8 | True      | False            |
