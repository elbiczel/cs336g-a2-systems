# Assignment report

## End to End Benchmarks (MBAir)
|    | device   |   batch_size | compile   | model   |   context_length |   fwd avg (sec) |   fwd std (sec) |   back avg (sec) |   back std (sec) |   fws & back avg (sec) |   fws & back std (sec) | status   |
|---:|:---------|-------------:|:----------|:--------|-----------------:|----------------:|----------------:|-----------------:|-----------------:|-----------------------:|-----------------------:|:---------|
|  0 | cpu      |            4 | False     | S       |              256 |        0.292967 |       0.0101263 |         0.690617 |        0.0515558 |               0.983585 |              0.0505515 | ok       |
|  1 | cpu      |            4 | False     | M       |              256 |        1.07968  |       0.0161518 |         2.07311  |        0.122161  |               3.15279  |              0.121089  | ok       |
|  2 | cpu      |            4 | False     | L       |              256 |        2.517    |       0.0938035 |         5.54676  |        0.212342  |               8.06376  |              0.1905    | ok       |
|  0 | cpu      |            4 | True      | S       |              256 |        0.295624 |      0.00836923 |         0.671863 |        0.0613006 |               0.967486 |              0.0607266 | ok       |
|  1 | cpu      |            4 | True      | M       |              256 |        1.06595  |      0.0177598  |         2.06168  |        0.0460032 |               3.12763  |              0.0424368 | ok       |
|  2 | cpu      |            4 | True      | L       |              256 |        2.46093  |      0.0541857  |         5.35662  |        0.159464  |               7.81755  |              0.149976  | ok       |
|  0 | mps      |            4 | False     | S       |              256 |        0.152136 |     0.000323014 |         0.350633 |       0.00910346 |               0.502768 |             0.00909772 | ok       |
|  1 | mps      |            4 | False     | M       |              256 |        0.497226 |     0.0113818   |         1.05638  |       0.0234968  |               1.55361  |             0.0205562  | ok       |
|  2 | mps      |            4 | False     | L       |              256 |        1.08069  |     0.0256076   |         2.58213  |       0.252054   |               3.66281  |             0.25075    | ok       |
|  0 | mps      |            4 | True      | S       |              256 |        0.154377 |      0.00253189 |         0.351856 |        0.0111889 |               0.506234 |              0.0108987 | ok       |
|  1 | mps      |            4 | True      | M       |              256 |        0.493877 |      0.00840203 |         1.05395  |        0.0220565 |               1.54783  |              0.0203935 | ok       |
|  2 | mps      |            4 | True      | L       |              256 |        1.09464  |      0.0196739  |         3.15047  |        0.487463  |               4.24511  |              0.487066  | ok       |

## End to End Benchmarks (RTX PRO 6000 WK)

|    | model   |   context_length |   fwd avg (sec) |   fwd std (sec) |   back avg (sec) |   back std (sec) |   fws & back avg (sec) |   fws & back std (sec) | status   | dtype   | device   |   batch_size | compile   | profile_memory   |
|---:|:--------|-----------------:|----------------:|----------------:|-----------------:|-----------------:|-----------------------:|-----------------------:|:---------|:--------|:---------|-------------:|:----------|:-----------------|
|  0 | S       |              256 |       0.0101203 |     4.39494e-05 |        0.0141196 |      0.000145315 |              0.0242399 |            0.000138509 | ok       | float32 | cuda     |            4 | False     | False            |
|  1 | M       |              256 |       0.0202569 |     9.18798e-05 |        0.0340681 |      0.00021485  |              0.0543251 |            0.000194213 | ok       | float32 | cuda     |            4 | False     | False            |
|  2 | L       |              256 |       0.0299634 |     6.69663e-05 |        0.0640944 |      0.000134777 |              0.0940578 |            0.000116963 | ok       | float32 | cuda     |            4 | False     | False            |
|  3 | XL      |              256 |       0.0497967 |     4.44305e-05 |        0.111272  |      7.55653e-05 |              0.161069  |            6.11232e-05 | ok       | float32 | cuda     |            4 | False     | False            |
|  4 | 2p7     |              256 |       0.0603869 |     0.000155709 |        0.160571  |      0.000173022 |              0.220958  |            7.54412e-05 | ok       | float32 | cuda     |            4 | False     | False            |

### No Warm-up

|    | model   |   context_length |   fwd avg (sec) |   fwd std (sec) |   back avg (sec) |   back std (sec) |   fws & back avg (sec) |   fws & back std (sec) | status   | dtype   | device   |   batch_size | compile   | profile_memory   |
|---:|:--------|-----------------:|----------------:|----------------:|-----------------:|-----------------:|-----------------------:|-----------------------:|:---------|:--------|:---------|-------------:|:----------|:-----------------|
|  0 | S       |              256 |       0.0353005 |      0.0790442  |      -0.00274821 |       0.0821705  |              0.0325523 |            0.0224501   | ok       | float32 | cuda     |            4 | False     | False            |
|  1 | M       |              256 |       0.034033  |      0.0423463  |       0.0219129  |       0.0424403  |              0.0559458 |            0.00282343  | ok       | float32 | cuda     |            4 | False     | False            |
|  2 | L       |              256 |       0.0352378 |      0.0151886  |       0.0588802  |       0.0151966  |              0.094118  |            0.000493203 | ok       | float32 | cuda     |            4 | False     | False            |
|  3 | XL      |              256 |       0.052992  |      0.00997852 |       0.110647   |       0.0100072  |              0.163639  |            0.000756646 | ok       | float32 | cuda     |            4 | False     | False            |
|  4 | 2p7     |              256 |       0.062647  |      0.00871239 |       0.158404   |       0.00873731 |              0.221051  |            0.000659412 | ok       | float32 | cuda     |            4 | False     | False            |

### 1 step warm up

|    | model   |   context_length |   fwd avg (sec) |   fwd std (sec) |   back avg (sec) |   back std (sec) |   fws & back avg (sec) |   fws & back std (sec) | status   | dtype   | device   |   batch_size | compile   | profile_memory   |
|---:|:--------|-----------------:|----------------:|----------------:|-----------------:|-----------------:|-----------------------:|-----------------------:|:---------|:--------|:---------|-------------:|:----------|:-----------------|
|  0 | S       |              256 |       0.0103984 |     0.000120235 |        0.0148159 |      0.00131654  |              0.0252143 |            0.00131104  | ok       | float32 | cuda     |            4 | False     | False            |
|  1 | M       |              256 |       0.0305459 |     0.0310978   |        0.0548498 |      0.0825875   |              0.0853957 |            0.0765089   | ok       | float32 | cuda     |            4 | False     | False            |
|  2 | L       |              256 |       0.0305613 |     0.000196254 |        0.0641871 |      0.000258344 |              0.0947484 |            0.000168006 | ok       | float32 | cuda     |            4 | False     | False            |
|  3 | XL      |              256 |       0.0499383 |     8.81006e-05 |        0.114248  |      0.000240845 |              0.164186  |            0.000224153 | ok       | float32 | cuda     |            4 | False     | False            |
|  4 | 2p7     |              256 |       0.0600362 |     0.00103386  |        0.161622  |      0.00105505  |              0.221659  |            0.000210359 | ok       | float32 | cuda     |            4 | False     | False            |

### Mixed Precision (bfloat16)

|    | model   |   context_length |   fwd avg (sec) |   fwd std (sec) |   back avg (sec) |   back std (sec) |   fws & back avg (sec) |   fws & back std (sec) | status   | dtype    | device   |   batch_size | compile   | profile_memory   |
|---:|:--------|-----------------:|----------------:|----------------:|-----------------:|-----------------:|-----------------------:|-----------------------:|:---------|:---------|:---------|-------------:|:----------|:-----------------|
|  0 | S       |              256 |       0.0115468 |     0.00025475  |        0.016251  |      0.00029472  |              0.0277978 |            0.000148198 | ok       | bfloat16 | cuda     |            4 | False     | False            |
|  1 | M       |              256 |       0.0242751 |     0.000599148 |        0.0316248 |      0.000637135 |              0.0558999 |            0.000216708 | ok       | bfloat16 | cuda     |            4 | False     | False            |
|  2 | L       |              256 |       0.0333411 |     6.47849e-05 |        0.0668117 |      9.27532e-05 |              0.100153  |            6.63783e-05 | ok       | bfloat16 | cuda     |            4 | False     | False            |
|  3 | XL      |              256 |       0.0547619 |     6.14746e-05 |        0.112735  |      0.000142991 |              0.167497  |            0.000129102 | ok       | bfloat16 | cuda     |            4 | False     | False            |
|  4 | 2p7     |              256 |       0.0485177 |     4.27052e-05 |        0.115897  |      7.1541e-05  |              0.164415  |            5.73967e-05 | ok       | bfloat16 | cuda     |            4 | False     | False            |

### Compiled

|    | model   |   context_length |   fwd avg (sec) |   fwd std (sec) |   back avg (sec) |   back std (sec) |   fws & back avg (sec) |   fws & back std (sec) | status   | dtype   | device   |   batch_size | compile   | profile_memory   |
|---:|:--------|-----------------:|----------------:|----------------:|-----------------:|-----------------:|-----------------------:|-----------------------:|:---------|:--------|:---------|-------------:|:----------|:-----------------|
|  0 | S       |              256 |      0.00508969 |     2.39174e-05 |       0.00899177 |      2.61624e-05 |              0.0140815 |            1.06034e-05 | ok       | float32 | cuda     |            4 | True      | False            |
|  1 | M       |              256 |      0.0356223  |     0.0792748   |       0.00021299 |      0.079275    |              0.0358352 |            0.00017528  | ok       | float32 | cuda     |            4 | True      | False            |
|  2 | L       |              256 |      0.0179603  |     0.000290359 |       0.0503096  |      0.000323146 |              0.0682699 |            0.000141828 | ok       | float32 | cuda     |            4 | True      | False            |
|  3 | XL      |              256 |      0.0385235  |     0.000203871 |       0.0943493  |      0.000235015 |              0.132873  |            0.000116913 | ok       | float32 | cuda     |            4 | True      | False            |
|  4 | 2p7     |              256 |      0.0516872  |     0.000636176 |       0.141835   |      0.000672963 |              0.193522  |            0.000219452 | ok       | float32 | cuda     |            4 | True      | False            |

### Mixed precision (bfloat16) & compiled

|    | model   |   context_length |   fwd avg (sec) |   fwd std (sec) |   back avg (sec) |   back std (sec) |   fws & back avg (sec) |   fws & back std (sec) | status   | dtype    | device   |   batch_size | compile   | profile_memory   |
|---:|:--------|-----------------:|----------------:|----------------:|-----------------:|-----------------:|-----------------------:|-----------------------:|:---------|:---------|:---------|-------------:|:----------|:-----------------|
|  0 | S       |              256 |      0.00615928 |     4.13104e-05 |       0.00826505 |      0.000401961 |              0.0144243 |            0.000399833 | ok       | bfloat16 | cuda     |            4 | True      | False            |
|  1 | M       |              256 |      0.0132246  |     2.07604e-05 |       0.019979   |      0.000427588 |              0.0332035 |            0.000427084 | ok       | bfloat16 | cuda     |            4 | True      | False            |
|  2 | L       |              256 |      0.0194133  |     7.00106e-05 |       0.0518976  |      0.00020119  |              0.0713109 |            0.000188615 | ok       | bfloat16 | cuda     |            4 | True      | False            |
|  3 | XL      |              256 |      0.0421143  |     7.45255e-05 |       0.0954155  |      0.000139824 |              0.13753   |            0.000118307 | ok       | bfloat16 | cuda     |            4 | True      | False            |
|  4 | 2p7     |              256 |      0.0370287  |     0.000182895 |       0.102367   |      0.000217848 |              0.139396  |            0.000118352 | ok       | bfloat16 | cuda     |            4 | True      | False            |

## Profiling

`uv run nsys profile -o data/result --trace=cuda,nvtx,osrt  python cs336_systems/run_benchmark.py --context_lengths 128 256 512 1024`


|    | model   |   context_length |   fwd avg (sec) |   fwd std (sec) |   back avg (sec) |   back std (sec) |   fws & back avg (sec) |   fws & back std (sec) | status                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | dtype   | device   |   batch_size | compile   | profile_memory   |
|---:|:--------|-----------------:|----------------:|----------------:|-----------------:|-----------------:|-----------------------:|-----------------------:|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:--------|:---------|-------------:|:----------|:-----------------|
|  0 | S       |              128 |       0.0108259 |     9.52752e-05 |       0.014839   |      0.000107186 |              0.0256649 |            4.91073e-05 | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
|  1 | S       |              256 |       0.0209489 |     0.0312535   |       0.00489793 |      0.0312538   |              0.0258468 |            0.000131269 | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
|  2 | S       |              512 |       0.0112468 |     8.8404e-05  |       0.0239687  |      0.000108986 |              0.0352154 |            6.37396e-05 | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
|  3 | S       |             1024 |       0.0345902 |     1.77913e-05 |       0.0811881  |      0.000126361 |              0.115778  |            0.000125102 | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
|  4 | M       |              128 |       0.0217993 |     0.00014868  |       0.0288768  |      0.000285685 |              0.0506761 |            0.000243947 | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
|  5 | M       |              256 |       0.0219659 |     0.000373715 |       0.0337879  |      0.000403169 |              0.0557538 |            0.000151269 | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
|  6 | M       |              512 |       0.0272296 |     6.86857e-05 |       0.0690668  |      0.000117095 |              0.0962964 |            9.48348e-05 | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
|  7 | M       |             1024 |       0.0962841 |     0.000488491 |       0.22175    |      0.000594176 |              0.318034  |            0.000338263 | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
|  8 | L       |              128 |       0.0323538 |     0.000134694 |       0.0437281  |      0.00286596  |              0.0760819 |            0.00286279  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
|  9 | L       |              256 |       0.0325457 |     5.60227e-05 |       0.0587253  |      0.000144978 |              0.0912711 |            0.000133716 | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
| 10 | L       |              512 |       0.0540713 |     0.000118362 |       0.134501   |      0.00016718  |              0.188572  |            0.000118066 | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
| 11 | L       |             1024 |       0.181613  |     7.67707e-05 |       0.423614   |      0.00017713  |              0.605227  |            0.000159629 | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
| 12 | XL      |              128 |       0.042624  |     0.000116976 |       0.076606   |      0.000244657 |              0.11923   |            0.00021488  | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
| 13 | XL      |              256 |       0.0507179 |     0.000103916 |       0.114765   |      0.00029028  |              0.165483  |            0.000271043 | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
| 14 | XL      |              512 |       0.120466  |     7.45836e-05 |       0.286982   |      0.0325134   |              0.407448  |            0.0325133   | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
| 15 | XL      |             1024 |       0.334767  |     0.000127612 |       0.751798   |      0.000409384 |              1.08657   |            0.000388986 | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
| 16 | 2p7     |              128 |       0.0345491 |     0.000111487 |       0.102499   |      0.000282473 |              0.137048  |            0.000259542 | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
| 17 | 2p7     |              256 |       0.0618612 |     0.000193117 |       0.163147   |      0.000262462 |              0.225008  |            0.000177742 | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
| 18 | 2p7     |              512 |       0.147304  |     0.000145481 |       0.34245    |      0.000354955 |              0.489754  |            0.000323772 | ok                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | float32 | cuda     |            4 | False     | False            |
| 19 | 2p7     |             1024 |     nan         |   nan           |     nan          |    nan           |            nan         |          nan           | OutOfMemoryError: CUDA out of memory. Tried to allocate 512.00 MiB. GPU 0 has a total capacity of 94.97 GiB of which 106.81 MiB is free. Including non-PyTorch memory, this process has 94.86 GiB memory in use. Of the allocated memory 88.71 GiB is allocated by PyTorch, and 5.49 GiB is reserved by PyTorch but unallocated. If reserved but unallocated memory is large try setting PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True to avoid fragmentation.  See documentation for Memory Management  (https://pytorch.org/docs/stable/notes/cuda.html#environment-variables) | float32 | cuda     |            4 | False     | False            |

### Mixed precision (bfloat16) & compiled

`uv run nsys profile -o data/result_comp_bflt16 --trace=cuda,nvtx,osrt  python cs336_systems/run_benchmark.py --context_lengths 128 256 512 1024 --compile --autocast_dtype bfloat16`

|    | model   |   context_length |   fwd avg (sec) |   fwd std (sec) |   back avg (sec) |   back std (sec) |   fws & back avg (sec) |   fws & back std (sec) | status   | dtype    | device   |   batch_size | compile   | profile_memory   |
|---:|:--------|-----------------:|----------------:|----------------:|-----------------:|-----------------:|-----------------------:|-----------------------:|:---------|:---------|:---------|-------------:|:----------|:-----------------|
|  0 | S       |              128 |      0.00628807 |     3.74235e-05 |       0.00834398 |      0.000199134 |              0.014632  |            0.000195586 | ok       | bfloat16 | cuda     |            4 | True      | False            |
|  1 | S       |              256 |      0.0073087  |     2.27559e-05 |       0.00747463 |      0.000116312 |              0.0147833 |            0.000114064 | ok       | bfloat16 | cuda     |            4 | True      | False            |
|  2 | S       |              512 |      0.00781423 |     2.36892e-05 |       0.015778   |      7.18141e-05 |              0.0235923 |            6.77944e-05 | ok       | bfloat16 | cuda     |            4 | True      | False            |
|  3 | S       |             1024 |      0.0175212  |     1.86541e-05 |       0.0321904  |      0.000177956 |              0.0497116 |            0.000176975 | ok       | bfloat16 | cuda     |            4 | True      | False            |
|  4 | M       |              128 |      0.0141181  |     4.60029e-05 |       0.0167977  |      0.000884801 |              0.0309159 |            0.000883604 | ok       | bfloat16 | cuda     |            4 | True      | False            |
|  5 | M       |              256 |      0.0145871  |     4.51196e-05 |       0.019017   |      0.000122603 |              0.0336041 |            0.000113999 | ok       | bfloat16 | cuda     |            4 | True      | False            |
|  6 | M       |              512 |      0.0144644  |     6.65096e-05 |       0.0330766  |      9.3289e-05  |              0.0475411 |            6.54165e-05 | ok       | bfloat16 | cuda     |            4 | True      | False            |
|  7 | M       |             1024 |      0.0507139  |     4.85515e-05 |       0.0893309  |      8.59034e-05 |              0.140045  |            7.08672e-05 | ok       | bfloat16 | cuda     |            4 | True      | False            |
|  8 | L       |              128 |      0.0466611  |     0.000107836 |       0.0422174  |      0.0003359   |              0.0888785 |            0.00031812  | ok       | bfloat16 | cuda     |            4 | True      | False            |
|  9 | L       |              256 |      0.0461797  |     9.24392e-05 |       0.0592039  |      0.000218145 |              0.105384  |            0.000197592 | ok       | bfloat16 | cuda     |            4 | True      | False            |
| 10 | L       |              512 |      0.0467255  |     0.00026235  |       0.0797602  |      0.000285363 |              0.126486  |            0.00011227  | ok       | bfloat16 | cuda     |            4 | True      | False            |
| 11 | L       |             1024 |      0.0942693  |     8.19393e-05 |       0.194317   |      0.000186842 |              0.288586  |            0.000167916 | ok       | bfloat16 | cuda     |            4 | True      | False            |
| 12 | XL      |              128 |      0.0617984  |     0.00010021  |       0.0877376  |      0.0913154   |              0.149536  |            0.0913153   | ok       | bfloat16 | cuda     |            4 | True      | False            |
| 13 | XL      |              256 |      0.0615635  |     0.000102452 |       0.106189   |      0.000245486 |              0.167752  |            0.000223085 | ok       | bfloat16 | cuda     |            4 | True      | False            |
| 14 | XL      |              512 |      0.0663217  |     0.000113301 |       0.132196   |      0.000743068 |              0.198518  |            0.000734379 | ok       | bfloat16 | cuda     |            4 | True      | False            |
| 15 | XL      |             1024 |      0.171643   |     9.02135e-05 |       0.307729   |      0.000458549 |              0.479372  |            0.000449587 | ok       | bfloat16 | cuda     |            4 | True      | False            |
| 16 | 2p7     |              128 |      0.0391966  |     0.000219395 |       0.0882831  |      0.000342233 |              0.12748   |            0.000262658 | ok       | bfloat16 | cuda     |            4 | True      | False            |
| 17 | 2p7     |              256 |      0.0435431  |     9.11264e-05 |       0.109527   |      0.000217579 |              0.15307   |            0.000197577 | ok       | bfloat16 | cuda     |            4 | True      | False            |
| 18 | 2p7     |              512 |      0.0824182  |     7.42382e-05 |       0.183491   |      0.00029463  |              0.26591   |            0.000285124 | ok       | bfloat16 | cuda     |            4 | True      | False            |
| 19 | 2p7     |             1024 |      0.192958   |     0.000173403 |       0.372568   |      0.000719549 |              0.565526  |            0.000698343 | ok       | bfloat16 | cuda     |            4 | True      | False            |

## Mixed precision

### mixed_precision_accumulation

float32: tensor(10.0001)
float16: tensor(9.9531, dtype=torch.float16)
float32 adding float16: tensor(10.0021)
float32 adding float16 manually upcast: tensor(10.0021)

This is due to the precision of float16 that cannot represent 0.01 correctly, even when upcast before addition.

## Self Attention

### Benchmark

### Compiled Benchmark
